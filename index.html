<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.15.0/cdn/themes/light.css">
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.15.0/cdn/shoelace.js"></script>
    <style>
      .login-container {
        display: flex;
        flex-direction: row;
        align-items: flex-end;
        justify-content: center;
        width: 60ch;
        margin: 20vh auto 0 auto;
        gap: 1em;
        background: #fff;
        box-shadow: 0 2px 16px rgba(0,0,0,0.08);
        padding: 2em 2em 1.5em 2em;
        border-radius: 12px;
      }
      body {
        min-height: 100vh;
        background: #f6f8fa;
        margin: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
    </style>
  </head>
  <body>
    <div class="main"></div>
    <script type="module">
      const client_id = 'https://checkin.swf.pub/client.jsonld'
      const redirect_uri = 'https://checkin.swf.pub/'
      async function getActorId(id) {
        const re = /^(?:acct:)?(?<username>[^@]+)@(?<domain>(?:[A-Za-z0-9](?:[A-Za-z0-9-]{0,61}[A-Za-z0-9])?)(?:\.(?:[A-Za-z0-9](?:[A-Za-z0-9-]{0,61}[A-Za-z0-9])?))*)$/;
        const m = re.exec(id)
        if (!m) {
          throw new Error('bad Webfinger format')
        }
        const username = m.groups.username
        const domain = m.groups.domain
        const wfUrl = `https://${domain}/.well-known/webfinger?resource=acct:${username}%40${domain}`
        const res = await fetch(wfUrl)
        if (!res.ok) {
          throw new Error('Could not load webfinger')
        }
        const json = await res.json()
        if (!json.links) {
          throw new Error('No links in webfinger json')
        }
        const actorLink = json.links.find((obj) =>
          obj.rel == 'self' &&
          ['application/activity+json',
           'application/ld+json; profile="https://www.w3.org/ns/activitystreams"'].includes(obj.type)
        )
        if (!actorLink) {
          throw new Error('No ActivityPub actor ID in Webfinger')
        }
        return actorLink.href
      }

      async function getActor(actorId) {
        const res = await fetch(actorId)
        if (!res.ok) {
          throw new Error('Failure fetching actor')
        }
        return await res.json()
      }

      async function getAuthorizationEndpoint(actor) {
        return actor.endpoints?.oauthAuthorizationEndpoint
      }

      async function getTokenEndpoint(actor) {
        return actor.endpoints?.oauthTokenEndpoint
      }

      function generateCodeVerifier(length = 64) {
        const array = new Uint8Array(length);
        crypto.getRandomValues(array);
        return base64UrlEncode(array);
      }

      async function generateCodeChallenge(verifier) {
        const encoder = new TextEncoder();
        const data = encoder.encode(verifier);
        const digest = await crypto.subtle.digest('SHA-256', data);
        return base64UrlEncode(new Uint8Array(digest));
      }

      function base64UrlEncode(buffer) {
        const b64 = btoa(String.fromCharCode(...buffer));
        return b64
          .replace(/\+/g, '-')
          .replace(/\//g, '_')
          .replace(/=+$/, '');
      }

      async function loginWith(authorizationUrl) {
        const state = crypto.randomUUID()
        sessionStorage.setItem('oauth_state', state)
        const verifier = generateCodeVerifier()
        sessionStorage.setItem('oauth_pkce_verifier', verifier)
        const challenge = await generateCodeChallenge(verifier)
        const params = new URLSearchParams({
          response_type: 'code',
          client_id,
          redirect_uri,
          scope: 'read write',
          state,
          code_challenge: challenge,
          code_challenge_method:'S256',
        })
        window.location = `${authorizationUrl}?${params}`
      }

      async function handleResults(params) {
        const savedState = sessionStorage.getItem('oauth_state')
        sessionStorage.removeItem('oauth_state')
        if (params['state'] !== savedState) {
          console.error('Bad state')
        }
        if (params['error']) {
          console.error(params['error'])
        }
        if (params['code']) {
          const code = params['code']
          const url = sessionStorage.getItem('oauth_token_url')
          sessionStorage.removeItem('oauth_token_url')
          const code_verifier = sessionStorage.getItem('oauth_pkce_verifier')
          sessionStorage.removeItem('oauth_pkce_verifier')
          const tp = new URLSearchParams({
            grant_type: 'authorization_code',
            code,
            client_id,
            redirect_uri,
            code_verifier
          })
          const res = fetch($url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: tp})
          if (!res.ok) {
            console.error('Error')
          } else {
            const json = await res.json()
            localStorage.setItem('access_token', json.access_token)
            localStorage.setItem('refresh_token', json.refresh_token)
            localStorage.setItem('expires_in', json.expires_in)
          }
        }
      }
      document.addEventListener('DOMContentLoaded', function() {
        const main = document.querySelector('.main');
        main.innerHTML = '';
        if (window.location.search) {
          const params = new URLSearchParams(window.location.search)
          if (params['state']) {
            handleResults(params)
            // redirect to base
            window.location = redirect_uri
          }
        } else if (localStorage.getItem('access_token')) {
          main.innerHTML = `
            <sl-alert open variant="primary">Hello, World!</sl-alert>
          `;
        } else {
          main.innerHTML = `
            <div style="display: flex; flex-direction: column; align-items: center;">
              <h1 style="margin-bottom: 1.5em; font-size: 2.2em; font-weight: 700; color: #222; letter-spacing: 0.02em;">Checkin</h1>
              <div id="error-container" style="width: 100%; max-width: 60ch; margin-bottom: 1em;"></div>
              <div class="login-container">
                <sl-input id="webfinger" label="Webfinger ID" placeholder="user@example.com" style="flex:1;"></sl-input>
                <sl-button id="login-btn" variant="primary">Login</sl-button>
              </div>
            </div>
          `;
          // Add click handler for login button
          const loginBtn = document.getElementById('login-btn');
          const webfingerInput = document.getElementById('webfinger');
          const errorContainer = document.getElementById('error-container');
          // Helper to show error
          function showError(message) {
            errorContainer.innerHTML = `<sl-alert open variant="danger">${message}</sl-alert>`;
          }
          loginBtn.addEventListener('click', async () => {
            errorContainer.innerHTML = '';
            const id = webfingerInput.value.trim();
            if (!id) {
              showError('Please enter your Webfinger ID.');
              return;
            }
            try {
              const actorId = await getActorId(id)
              sessionStorage.setItem('oauth_actor_id', actorId)
              const actor = await getActor(actorId)
              const tokenUrl = await getTokenEndpoint(actor)
              sessionStorage.setItem('oauth_token_url', tokenUrl)
              const authorizationUrl = await getAuthorizationEndpoint(actor)
              await loginWith(authorizationUrl)
            } catch (error) {
              showError(error.message)
            }
          });
        }
      });
    </script>
  </body>
</html>